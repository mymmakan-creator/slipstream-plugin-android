name: Build Slipstream Android

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.2.12479018
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_API: 33
      TARGET_ABIS: armeabi-v7a,arm64-v8a

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: armv7-linux-androideabi,aarch64-linux-android
        profile: minimal
        override: true

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y cmake pkg-config git build-essential curl perl python3

    - name: Download Android NDK
      uses: android-actions/setup-ndk@v2
      with:
        ndk-version: 27.2.12479018

    - name: Build OpenSSL for all ABIs
      run: |
        git clone https://github.com/openssl/openssl.git openssl-android
        cd openssl-android

        declare -A ABI_CONFIGS=( ["armeabi-v7a"]="android-arm" ["arm64-v8a"]="android-arm64" )

        for ABI in ${!ABI_CONFIGS[@]}; do
          CONFIGURE=${ABI_CONFIGS[$ABI]}
          PREFIX="$PWD/build/$ABI"

          echo "Building OpenSSL for $ABI"
          ./Configure $CONFIGURE -D__ANDROID_API__=$ANDROID_API no-shared no-unit-test --prefix=$PREFIX
          make -j$(nproc)
          make install
        done

    - name: Build Rust libraries for all ABIs
      run: |
        cd app/src/main/rust/slipstream-rust

        declare -A TARGETS=( ["armeabi-v7a"]="armv7-linux-androideabi" ["arm64-v8a"]="aarch64-linux-android" )

        for ABI in ${!TARGETS[@]}; do
          TARGET=${TARGETS[$ABI]}
          OPENSSL_DIR="$(pwd)/../../../../openssl-android/build/$ABI"

          echo "Building Rust library for $ABI ($TARGET)"
          OPENSSL_DIR=$OPENSSL_DIR \
          OPENSSL_INCLUDE_DIR=$OPENSSL_DIR/include \
          OPENSSL_LIB_DIR=$OPENSSL_DIR/lib \
          OPENSSL_CRYPTO_LIBRARY=$OPENSSL_DIR/lib/libcrypto.a \
          OPENSSL_SSL_LIBRARY=$OPENSSL_DIR/lib/libssl.a \
          OPENSSL_USE_STATIC_LIBS=TRUE \
          cargo build --release --target $TARGET
        done

    - name: Copy Rust libs into Android project
      run: |
        for ABI in armeabi-v7a arm64-v8a; do
          mkdir -p app/src/main/jniLibs/$ABI
          cp app/src/main/rust/slipstream-rust/target/${ABI}-release/*.a app/src/main/jniLibs/$ABI/
        done

    - name: Build Android APK
      run: |
        cd ../../../..
        ./gradlew --no-daemon assembleRelease
